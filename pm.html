<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PM Panel</title>
<link rel="stylesheet" href="style.css">
</head>

<!-- 로그인 체크 -->
<script>
if (localStorage.getItem("loggedIn") !== "true") {
  window.location.href = "login.html";
}
function logout() {
  localStorage.removeItem("loggedIn");
  window.location.href = "login.html";
}
</script>

<body>
<header>
  <div class="container">
    <h1>PM Panel</h1>
    <nav class="menu">
      <a href="normal.html">일상 명령어</a>
      <a href="pb.html">프로퍼티/비즈니스</a>
      <a href="car.html">차량</a>
      <a href="tp.html">텔레포트</a>
      <a href="pm.html">PM 데이터</a>
      <button onclick="logout()" class="logout-btn">로그아웃</button>
    </nav>
  </div>
</header>

<main class="container">

<!-- 입력 폼 -->
<section id="pm-database">
  <h2>데이터 입력</h2>

  <!-- Business Form -->
  <div class="form-box">
    <h3>사업장 정보 입력</h3>
    <form id="businessForm">
      <label>사업장 이름 <input type="text" name="사업장 이름" required></label>
      <label>사업장 ID <input type="text" name="사업장 ID" required></label>
      <label>사업장 위치 <input type="text" name="사업장 위치"></label>
      <label>사업자 명 <input type="text" name="사업자 명"></label>
      <label>소유자 <input type="text" name="소유자"></label>
      <button type="submit">저장</button>
    </form>
  </div>

  <!-- Apart Form -->
  <div class="form-box">
    <h3>아파트 정보 입력</h3>
    <form id="apartForm">
      <label>아파트 명(호실) <input type="text" name="아파트 명(호실)" required></label>
      <label>임대인 명 <input type="text" name="임대인 명"></label>
      <label>직업 <input type="text" name="직업"></label>
      <label>연락처 <input type="text" name="연락처"></label>
      <label>비고 <textarea name="비고"></textarea></label>
      <button type="submit">저장</button>
    </form>
  </div>

  <!-- 데이터 보기 -->
  <h2>데이터 보기</h2>
  <div class="data-buttons">
    <button onclick="loadData('business')">사업장</button>
    <button onclick="loadData('apart')">아파트</button>
  </div>
  <div id="data-table"></div>
</section>

</main>

<footer>
  <p>© 2025 GTAW:KR Admin PM Panel</p>
</footer>

<script>
const scriptURL = "YOUR_SCRIPT_URL"; // Google Apps Script Web App URL

// Business Form 저장
document.getElementById("businessForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  formData.append("sheet", "business");
  formData.append("action", "add");

  fetch(scriptURL, { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      alert("사업장 정보 저장 완료 ✅");
      this.reset();
      loadData('business');
    })
    .catch(err => alert("저장 실패 ❌"));
});

// Apart Form 저장
document.getElementById("apartForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const formData = new FormData(this);
  formData.append("sheet", "apart");
  formData.append("action", "add");

  fetch(scriptURL, { method: "POST", body: formData })
    .then(res => res.json())
    .then(data => {
      alert("아파트 정보 저장 완료 ✅");
      this.reset();
      loadData('apart');
    })
    .catch(err => alert("저장 실패 ❌"));
});

// 데이터 로드
function loadData(sheet) {
  fetch(`${scriptURL}?sheet=${sheet}`)
    .then(res => res.json())
    .then(data => renderTable(data, sheet))
    .catch(err => alert("데이터 로드 실패 ❌"));
}

// 테이블 렌더링
function renderTable(data, sheet) {
  if(!data || data.length === 0) {
    document.getElementById("data-table").innerHTML = "<p>데이터가 없습니다.</p>";
    return;
  }

  const headers = Object.keys(data[0]);
  let html = '<table>';
  html += '<thead><tr>';
  headers.forEach(h => html += `<th>${h}</th>`);
  html += '<th>삭제</th>';
  html += '</tr></thead><tbody>';

  data.forEach((row, index) => {
    html += '<tr>';
    headers.forEach(h => html += `<td>${row[h]}</td>`);
    html += `<td><button class="delete-btn" onclick="deleteRow('${sheet}', ${index})">삭제</button></td>`;
    html += '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById("data-table").innerHTML = html;
}

// 삭제 함수
function deleteRow(sheet, index) {
  if(confirm("정말 삭제하시겠습니까?")) {
    const formData = new FormData();
    formData.append("sheet", sheet);
    formData.append("action", "delete");
    formData.append("rowIndex", index);

    fetch(scriptURL, { method: "POST", body: formData })
      .then(res => res.json())
      .then(res => {
        if(res.status === "deleted") {
          alert("삭제 완료 ✅");
          loadData(sheet);
        } else {
          alert("삭제 실패 ❌");
        }
      });
  }
}
</script>
</body>
</html>
